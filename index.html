<style>
  body {
    background-color: black;
    font-family: sans-serif;
    color: white;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="http://www.youtube.com/player_api"></script>

<script>
  var prefix = 'https://api.themoviedb.org/3/';
  var apiKey = '8f9dc61dae4de5e1d69cf48ab6be2c64';
  var player;

  function getQueryString() {
    return '?api_key=' + apiKey + '&language=en-US';
  }

  function getUpcomingMovies(onDone, onFailure) {
    var command = 'movie/now_playing';
    var url = prefix + command + getQueryString() + '&page=1';

    var request = $.get(url);
    request.done(function(response) {
      onDone(response.results);
    });
    request.fail(onFailure);
  }

  function getVideos(movie, onDone, onFailure) {
    var command = 'movie/' + movie.id + '/videos';
    var url = prefix + command + getQueryString();

    var request = $.get(url);
    request.done(function(response) {
      onDone(response.results);
    });
    request.fail(onFailure);
  }

  function setupPlayer(onReady) {
    player = new YT.Player('trailer-container', {
      height: '100%',
      width: '100%',
      playerVars: {
        controls: 0,
        disablekb: 1,
        iv_load_policy: 3,
        modestbranding: 1,
        showinfo: 0
      },
      events: {
        onReady: onReady,
      }
    });
  };

  function playRandomTrailer(movies) {
    var randomMovieIndex = Math.round(Math.random() * movies.length);
    var randomMovie = movies[randomMovieIndex];

    getVideos(randomMovie, function(videos) {
      // TODO: Find one that is of type "Tralier" and the biggest size possible.
      var video = videos[0];
      player.loadVideoById(video.key);

      player.addEventListener('onStateChange', function(event) {
        if (event.data == YT.PlayerState.ENDED) {
          // Play the next one.
          playRandomTrailer(movies);
        }
      });
    });
  }

  $(window).on('load', function() {
    setupPlayer(function() {
      getUpcomingMovies(function(upcomingMovies) {
        if (upcomingMovies.length > 0) {
          playRandomTrailer(upcomingMovies);
        }
      });
    });
  });
</script>

<title>Latest Trailers</title>

<div id="trailer-container"></div>
